name: Publish Latest

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      force:
        required: false
        description: 'Set --force to force push this release'
        default: ''
      verbose:
        description: "Set --verbose to get verbose build output"
        required: false
        default: ''

env:
  VERBOSE: ${{ github.events.input.verbose }}
  FORCE_RELEASE: ${{ github.events.inputs.force }}

jobs:
  github_release:
    name: Publish artifact to GitHub Releases (${{ matrix.artifact }}-${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        artifact: [fluvio, fluvio-run]
        target: [x86_64-unknown-linux-musl, x86_64-apple-darwin]
    steps:
      - name: Login GH CLI
        run: gh auth login --with-token < <(echo ${{ secrets.GITHUB_TOKEN }})
      - name: Download artifact
        uses: actions/download-artifact@v2
        with:
          name: ${{ matrix.artifact }}-${{ matrix.target }}-${{ github.sha }}
      - name: Rename artifact
        run: mv ${{ matrix.artifact }} ${{ matrix.artifact }}-${{ matrix.target }}
      - name: Publish artifact
        run: gh release upload -R infinyon/fluvio --clobber dev ./${{ matrix.artifact }}-${{ matrix.target }}

  docker:
    name: Publish Latest Image
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        rust: [stable]
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v2
        with:
          name: fluvio-run-x86_64-unknown-linux-${{ github.sha }}

      - name: Login to Docker Hub
        run: docker login --username=${{ secrets.DOCKER_USERNAME }} --password=${{ secrets.DOCKER_PASSWORD }}

      - name: Publish latest development Fluvio Image
        run: k8-util/docker/build.sh "$(cat VERSION)-${{ github.sha }}" "./fluvio-run-x86_64-unknown-linux-${{ github.sha }}"

  helm:
    name: Publish Latest Helm Chart
    needs: docker
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install Helm
        run: actions/ci-replace-helm.sh
        env:
          HELM_VERSION: v3.3.4
          OS: ${{ matrix.os }}
      - name: Install Helm Push plugin
        run: helm plugin install https://github.com/chartmuseum/helm-push.git
      - name: Helm Add Repo
        run: helm repo add chartmuseum https://gitops:${{ secrets.HELM_PASSWORD }}@charts.fluvio.io
      - name: Push Sys Chart
        run: helm push k8-util/helm/fluvio-sys --version="$(cat VERSION)-$(git rev-parse HEAD)" chartmuseum
      - name: Push App Chart
        run: helm push k8-util/helm/fluvio-app --version="$(cat VERSION)-$(git rev-parse HEAD)" chartmuseum

  fluvio:
    name: Publish Fluvio CLI
    runs-on: ubuntu-latest
    steps:
      - name: Install cargo-make
        uses: davidB/rust-cargo-make@v1
        with:
          version: '0.32.9'
      - name: Install fluvio-package
        run: |
          curl -fsS https://packages.fluvio.io/v1/install.sh | bash
          ${HOME}/.fluvio/bin/fluvio install fluvio-package
      - name: Download artifact (x86_64-unknown-linux-musl)
        uses: actions/download-artifact@v2
        with:
          name: fluvio-x86_64-unknown-linux-musl-${{ github.sha }}
          path: target/x86_64-unknown-linux-musl/release/fluvio
      - name: Download artifact (x86_64-apple-darwin)
        uses: actions/download-artifact@v2
        with:
          name: fluvio-x86_64-apple-darwin-${{ github.sha }}
          path: target/x86_64-apple-darwin/release/fluvio
      - name: Publish to Fluvio Packages
        run: |
          ${HOME}/.fluvio/bin/fluvio package publish \
            --version="$(cat VERSION)+$(git rev-parse HEAD)" \
            target/x86_64-unknown-linux-musl/release/fluvio \
            target/x86_64-apple-darwin/release/fluvio

  # Bump the latest version of the Fluvio CLI on the package registry
  # This must be a distinct job than publish_fluvio_cli because this job requires
  # that all targets are first published successfully before we can bump the version.
  bump_fluvio_cli:
    name: Bump Fluvio CLI version
    needs: fluvio
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install cargo-make
        uses: davidB/rust-cargo-make@v1
        with:
          version: '0.32.9'
      - name: Set prod env
        if: ${{ github.event.inputs.test == '' }}
        run: |
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
      - name: Bump latest version of Fluvio CLI on fluvio-packages
        env:
          RUST_LOG: debug
        run: cargo make bump-fluvio-latest
