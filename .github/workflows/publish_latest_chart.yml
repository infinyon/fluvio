name: Publish Helm Chart

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  publish_helm:
    name: Publish Helm Chart
    runs-on: ubuntu-latest
    steps:
      - name: Install Helm
        run: |
          mkdir -p $HOME/bin && \
          cd $(mktemp -d) && \
          curl -sSL https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz | tar zx && \
          mv linux-amd64/helm $HOME/bin && \
          chmod +x $HOME/bin/helm
        env:
          HELM_VERSION: v3.3.3
      - name: Install Helm Push plugin
        run: helm plugin install https://github.com/chartmuseum/helm-push.git
      - name: Helm Add Repo
        run: helm repo add chartmuseum https://gitops:${{ secrets.HELM_PASSWORD }}@charts.fluvio.io
      - uses: actions/checkout@v2
      - name: Push Sys Chart
        run: helm push k8-util/helm/fluvio-sys --version="$(cat VERSION)-latest" --force chartmuseum
      - name: Push App Chart
        run: helm push k8-util/helm/fluvio-app --version="$(cat VERSION)-latest" --force chartmuseum
