apiVersion: fluvio.infinyon.com/v1
kind: SmartStream
metadata:
  name: route-agg-stream1 
spec:
  inputs:
    topicSelector:
      name: route
  phase:
    transform: 
      moduleSelector:
        name: route-agg-module
---
apiVersion: fluvio.infinyon.com/v1
kind: SmartStream
metadata:
  name: route-agg-stream2
spec:
  inputs:
    topicSelector:  
      name:route
  phase:
    transform:
        template:
          metadata: 
            name: route-module
          spec:
            input_kind: Stream
            output_kind: Stream
            wasm:
              format: BINARY
              payload: AAAAAA
            parameters:
              - name: route
---
apiVersion: fluvio.infinyon.com/v1
kind: SmartStream
metadata:
  name: bus-arrival-prediction
spec:
  inputs:
    topicSelector: 
      name: BusEvents
    streams:
    - smartStreamSelector:
        name: route_agg-stream-1
        id: route
  phases:
    transform: 
      moduleSelector:: 
        name: bus-route-joint-module
  tableFormat:
      moduleSelector: 
        name: bus-joint-table
  mapformat:
    mapSelector:
        name: bus-openstreemap
---
apiVersion: fluvio.infinyon.com/v1
kind: SmartStream
metadata:
  name: bus-arrival-prediction
spec:
  inputs:
    topicSelector: 
      name: BusEvents
    streams:
    - smartStreamSelector:
        name: route_agg-stream-1
        id: route
  modules:
    - phase: transform
      selector:
        name: bus-route-joint-module
    - phase: output
      format: table
      selector: 
        name: bus-joint-table
    - phase: output
      format: map
      selector:
        name: bus-openstreemap
---
apiVersion: fluvio.infinyon.com/v1
kind: SmartProducer
metadata:
  name: bus-clean-filter
spec:
  target:
    topicSelector: 
      name: BusEvents
  phase:
    access:
      moduleSelector:
        name: rbac-module
    filter: 
      moduleSelector: 
        name: bus-produce-filter
